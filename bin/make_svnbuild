#!/bin/bash

URL=$1;

WHICH=/usr/bin/which;

AWK=$($WHICH awk);
CAT=$($WHICH cat);
DCH=$($WHICH dch);
DEBUILD=$($WHICH debuild);
FIND=$($WHICH find);
GREP=$($WHICH grep);
HEAD=$($WHICH head);
MKTEMP=$($WHICH mktemp);
PBUILDER=$($WHICH pbuilder);
REPREPRO=$($WHICH reprepro);
RM=$($WHICH rm);
SED=$($WHICH sed);
SUDO=$($WHICH sudo);
SVN=$($WHICH svn);


REVISION=$($SVN info $1 | $GREP "Revision:" | $AWK '{ print $2; }');
VERSION=$($SVN cat $URL/debian/changelog | $HEAD -n 1 | $AWK '{ print substr($2, 2, length($2) - 2); }');
SNAPSHOT_VERSION="$VERSION~svn$REVISION";
NAME=$($SVN cat $URL/debian/changelog | $HEAD -n 1 | $AWK '{ print $1; }');
DIR_NAME="$NAME-$SNAPSHOT_VERSION";
BUILD_RESULT=$($MKTEMP -d);
REPOS_ROOT="/home/chris/lib/network/repos.cs278.org";
DIST=$2;

echo "Going to build $DIR_NAME";

$SVN export --quiet $URL "$DIR_NAME";

cd "$DIR_NAME";

$SED --in-place "s/($VERSION)/($SNAPSHOT_VERSION)/" debian/changelog;

$DCH --maintmaint --append "SVN Auto Release";
$DCH --maintmaint --release --distribution $DIST "SVN Auto Release";

(
$DEBUILD -S &&
$SUDO $PBUILDER build --buildresult $BUILD_RESULT ../"${NAME}_$SNAPSHOT_VERSION".dsc;
) 2> /dev/null || exit 1;

cd $REPOS_ROOT;

$REPREPRO -S extra -P optional --component snapshots includedsc $DIST "$BUILD_RESULT/${NAME}_$SNAPSHOT_VERSION".dsc
$FIND "$BUILD_RESULT" -name "*.deb" -exec $REPREPRO --component snapshots includedeb $DIST '{}' \;

$RM -rf $BUILD_RESULT;
