#!/usr/bin/php
<?php

define('CMD_VOLUME', '/home/chris/bin/volume');
define('MAX_VOLUME', 32);
//define('STEPS', 30);
//define('STEP_RATE', 1/60);
define('CUSHION', 15 * 60);

function get_volume()
{
	return (int) exec(CMD_VOLUME);
}

function set_volume($volume)
{
	return CMD_VOLUME . ' ' . $volume;
}

if (sizeof($argv) != 3)
{
	echo 'Invalid Parameters', "\n";
	exit(1);
}

array_shift($argv);
$start = strtotime(array_shift($argv));
$event = strtotime(array_shift($argv));
$end = $event - CUSHION;

echo date('r', $start), ' ', date('r', $end), "\n";

// Volume step per minute
$volume_step = round((MAX_VOLUME - get_volume()) / (($end - $start) / 60), 2);
echo "Steps of $volume_step per minute\n";

$volume_counter = get_volume();

$at_task = array(
	set_volume(get_volume()),
	'/usr/bin/mpc play',
	'/bin/sleep 1m',
);

for ($minute = 1; $minute <= (($end - $start) / 60); $minute++)
{
	$at_task[] = set_volume($volume_counter + ($volume_step * $minute));
	$at_task[] = '/bin/sleep 1m';
}

$at_task = implode(';', $at_task);

print $at_task;

?>

<?php
/*

#!/bin/sh

WHEN=$1;
#WHAT=$2;

PULSE_VOLUME="$HOME/bin/volume 90%; sleep 0.5; $HOME/bin/volume 70%; sleep 1;";
PULSE_VOLUME="$PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME";
PULSE_VOLUME="$PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME";

WHAT="/usr/bin/mpc play; $HOME/bin/volume 50%; sleep 5m; $HOME/bin/volume 60%; sleep 5m; $HOME/bin/volume 70%; sleep 2m; $PULSE_VOLUME $PULSE_VOLUME $PULSE_VOLUME";

# Switch to home directory
cd

echo "Doing .. $WHAT";

echo $WHAT | /usr/bin/at $WHEN

*/
?>
